<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Vérification 2FA | ClutchX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ asset('assets/css/bootstrap-lib/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/font-awesome-lib/icon/font-awesome.min.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; overflow-x: hidden; }

        .bg-video { position: fixed; inset: 0; z-index: 0; }
        .bg-video video { width: 100%; height: 100%; object-fit: cover; }
        .bg-video .overlay { position: absolute; inset: 0; background: linear-gradient(160deg, rgba(16,10,46,0.88) 0%, rgba(30,10,60,0.92) 100%); }

        .page { position: relative; z-index: 2; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 40px 16px; }

        .card {
            width: 100%; max-width: 420px;
            background: rgba(255,255,255,0.06); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;
            padding: 36px 32px 28px; color: #fff;
            box-shadow: 0 24px 64px rgba(0,0,0,0.4);
        }

        .card-header { text-align: center; margin-bottom: 28px; }
        .card-header .icon-circle {
            width: 64px; height: 64px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            margin-bottom: 14px; font-size: 1.6rem;
        }
        .card-header h2 { font-size: 1.5rem; font-weight: 700; margin: 0 0 4px; }
        .card-header p { font-size: 0.85rem; color: rgba(255,255,255,0.55); margin: 0; line-height: 1.5; }

        .error-box {
            display: flex; align-items: flex-start; gap: 8px; margin-bottom: 18px;
            padding: 12px 16px; border-radius: 10px;
            background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.25);
        }
        .error-box i { color: #f87171; margin-top: 2px; }
        .error-box span { color: #fca5a5; font-size: 0.85rem; line-height: 1.4; }

        .code-input-wrap { margin-bottom: 24px; }
        .code-input-wrap label {
            display: block; font-size: 0.78rem; font-weight: 500;
            color: rgba(255,255,255,0.7); margin-bottom: 10px;
            letter-spacing: 0.02em; text-transform: uppercase; text-align: center;
        }
        .code-boxes {
            display: flex; gap: 8px; justify-content: center;
        }
        .code-boxes input {
            width: 48px; height: 56px;
            text-align: center; font-size: 1.4rem; font-weight: 700;
            font-family: 'Inter', monospace;
            border: 1.5px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            background: rgba(255,255,255,0.07); color: #fff;
            outline: none; transition: all 0.25s;
        }
        .code-boxes input:focus {
            border-color: #a855f7; background: rgba(255,255,255,0.12);
            box-shadow: 0 0 0 3px rgba(168,85,247,0.2);
        }
        .code-boxes input.filled { border-color: #a855f7; background: rgba(168,85,247,0.1); }

        /* Hidden real input for form submission */
        .hidden-code-input { position: absolute; opacity: 0; pointer-events: none; }

        .btn-submit {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: #fff; font-size: 0.95rem; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(124,58,237,0.35); }
        .btn-submit:active { transform: translateY(0); }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-cancel {
            display: block; text-align: center; margin-top: 18px;
            color: rgba(255,255,255,0.45); font-size: 0.84rem; text-decoration: none;
            transition: color 0.2s;
        }
        .btn-cancel:hover { color: #f87171; }

        .timer-text {
            text-align: center; margin-top: 16px;
            font-size: 0.78rem; color: rgba(255,255,255,0.35);
        }
        .timer-text i { margin-right: 4px; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .shake { animation: shake 0.5s; }

        @media (max-width: 400px) {
            .code-boxes input { width: 40px; height: 48px; font-size: 1.2rem; }
            .card { padding: 28px 20px 22px; }
        }
    </style>
</head>

<body>

<div class="bg-video">
    <video autoplay loop muted playsinline>
        <source src="{{ asset('assets/images/index/header-video.mp4') }}" type="video/mp4">
    </video>
    <div class="overlay"></div>
</div>

<div class="page">
    <div class="card" id="verifyCard">

        <div class="card-header">
            <div class="icon-circle">
                <i class="fa fa-lock" style="color:#fff"></i>
            </div>
            <h2>Vérification 2FA</h2>
            <p>Ouvrez <strong>Google Authenticator</strong> et saisissez le code à 6 chiffres affiché pour votre compte ClutchX</p>
        </div>

        {% if error %}
            <div class="error-box" id="errorBox">
                <i class="fa fa-exclamation-triangle"></i>
                <span>{{ error }}</span>
            </div>
        {% endif %}

        <form method="post" action="{{ path('app_login_2fa_verify') }}" id="totpForm">

            <div class="code-input-wrap">
                <label>Code d'authentification</label>
                <div class="code-boxes" id="codeBoxes">
                    <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="0" autofocus>
                    <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="1">
                    <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="2">
                    <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="3">
                    <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="4">
                    <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="5">
                </div>
                <input type="hidden" name="totp_code" id="totpCode" value="">
            </div>

            <button type="submit" class="btn-submit" id="submitBtn" disabled>
                <i class="fa fa-shield"></i> Vérifier
            </button>
        </form>

        <a href="{{ path('app_login_2fa_cancel') }}" class="btn-cancel">
            <i class="fa fa-times"></i> Annuler et revenir à la connexion
        </a>

        <div class="timer-text">
            <i class="fa fa-clock-o"></i> Le code change toutes les 30 secondes
        </div>

    </div>
</div>

<script>
(function() {
    const digits = document.querySelectorAll('.code-digit');
    const hiddenInput = document.getElementById('totpCode');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('totpForm');

    function updateHiddenInput() {
        let code = '';
        digits.forEach(d => { code += d.value; });
        hiddenInput.value = code;
        submitBtn.disabled = code.length < 6;

        // Auto-submit when all 6 digits entered
        if (code.length === 6) {
            submitBtn.disabled = false;
            setTimeout(() => form.submit(), 150);
        }
    }

    digits.forEach((input, i) => {
        input.addEventListener('input', function(e) {
            const val = this.value.replace(/\D/g, '');
            this.value = val.charAt(0) || '';

            if (this.value) {
                this.classList.add('filled');
                if (i < 5) digits[i + 1].focus();
            } else {
                this.classList.remove('filled');
            }
            updateHiddenInput();
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !this.value && i > 0) {
                digits[i - 1].focus();
                digits[i - 1].value = '';
                digits[i - 1].classList.remove('filled');
                updateHiddenInput();
            }
        });

        // Handle paste
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, 6);
            pasted.split('').forEach((char, idx) => {
                if (digits[idx]) {
                    digits[idx].value = char;
                    digits[idx].classList.add('filled');
                }
            });
            if (pasted.length > 0 && digits[Math.min(pasted.length, 5)]) {
                digits[Math.min(pasted.length, 5)].focus();
            }
            updateHiddenInput();
        });
    });

    // Shake animation on error
    const errorBox = document.getElementById('errorBox');
    if (errorBox) {
        document.getElementById('verifyCard').classList.add('shake');
        digits[0].focus();
    }
})();
</script>

</body>
</html>
